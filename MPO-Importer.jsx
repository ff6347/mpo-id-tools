// You must copy the file "glue code.jsx" from the XML Rules folder// (inside the Scripts  folder inside your InDesign folder)// to the folder meta below the older containing this script,// or provide a full path to the file in the next line.// Copyright (C) 2011 - 2013 Fabian "fabiantheblind" Morón Zirfas// http://www.the-moron.net// info [at] the - moron . net// This program is free software: you can redistribute it and/or modify// it under the terms of the GNU General Public License as published by// the Free Software Foundation, either version 3 of the License, or// any later version.// This program is distributed in the hope that it will be useful,// but WITHOUT ANY WARRANTY; without even the implied warranty of// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the// GNU General Public License for more details.// You should have received a copy of the GNU General Public License// along with this program. If not, see <http://www.gnu.org/licenses/.#include "./meta/glue code.jsx";// //#include "./meta/processXML.jsx";#include "./meta/processXML_v02.jsx";#include "./meta/setupStyles.jsx";var obj = {};  obj.mode = null;  obj.xmlexist = null;  obj.rmvxml = null;main();// ------------function myGetFileName(){  var myFolder = app.activeDocument.filePath;      var myFile =  new File( myFolder+'/log.txt' );//      if ( myFile === null ){exit()};   return myFile;}function mapManually(doc){  //myDoc.xmlImportMaps.add(myDoc.xmlTags.item("artikelNr"),myDoc.paragraphStyles.item("ARTIKEL_Nr"));  doc.xmlImportMaps.add(doc.xmlTags.item("laufNummer"),doc.characterStyles.item("laufNummer"));  doc.xmlImportMaps.add(doc.xmlTags.item("artikelBezeichnungMitLN"),doc.paragraphStyles.item("ARTIKEL_Bezeichnung")) ;  doc.xmlImportMaps.add(doc.xmlTags.item("artikelBezeichnung"),doc.paragraphStyles.item("ARTIKEL_Bezeichnung")) ;  doc.xmlImportMaps.add(doc.xmlTags.item("artikelBeschreibung"),doc.paragraphStyles.item("ARTIKEL_Beschreibung")) ;  doc.xmlImportMaps.add(doc.xmlTags.item("artikelText"),doc.paragraphStyles.item("ARTIKEL_Text")) ;  doc.xmlImportMaps.add(doc.xmlTags.item("artikelText_Aufzaehlung"),doc.paragraphStyles.item("ARTIKEL_Text")) ;  doc.xmlImportMaps.add(doc.xmlTags.item("artikelZeileANBPmitLN"),doc.paragraphStyles.item("ARTIKEL_Zeile_ANBP_mit_LN")) ;  doc.xmlImportMaps.add(doc.xmlTags.item("artikelZeileANPmitLN"),doc.paragraphStyles.item("ARTIKEL_Zeile_ANP_mit_LN")) ;  doc.xmlImportMaps.add(doc.xmlTags.item("artikelZeileABPmitLN"),doc.paragraphStyles.item("ARTIKEL_Zeile_ABP_mit_LN")) ;  doc.xmlImportMaps.add(doc.xmlTags.item("artikelZeileANBPohneLN"),doc.paragraphStyles.item("ARTIKEL_Zeile_ANBP_ohne_LN")) ;  doc.xmlImportMaps.add(doc.xmlTags.item("artikelZeileANPohneLN"),doc.paragraphStyles.item("ARTIKEL_Zeile_ANP_ohne_LN")) ;  doc.xmlImportMaps.add(doc.xmlTags.item("artikelZeileABPohneLN"),doc.paragraphStyles.item("ARTIKEL_Zeile_ABP_ohne_LN")) ;  doc.xmlImportMaps.add(doc.xmlTags.item("laufNummerBild"),doc.paragraphStyles.item("LAUFNUMMER_am_Bild")) ;  doc.xmlImportMaps.add(doc.xmlTags.item("preis"),doc.paragraphStyles.item("PREIS")) ;  doc.mapXMLTagsToStyles();}function main(){  // Check for a document    var myDoc = null;  try{ myDoc = app.activeDocument;    }catch(e){    alert("No no no, you have no document.\nMaybe you should drink some coffee");    return;  }  var numOfItems;  var myDate = new Date();  var myLogFile = null;  try{    myLogFile =  myGetFileName();  }catch(e){    alert("You need to save your docuemnt");    myDoc.save();    myDoc = app.activeDocument;    var myLogFile = myGetFileName();  }  var myFileContent = myLogFile.read();  var myErrorLog = myFileContent +"\n"+"Starting Log file at "+myDate +"\n";  var myItemsList = [];  var myList;  var myPageName;  var myPage;    // with(myDoc){    myDoc.viewPreferences.horizontalMeasurementUnits = MeasurementUnits.MILLIMETERS;    myDoc.viewPreferences.verticalMeasurementUnits = MeasurementUnits.MILLIMETERS;    myDoc.viewPreferences.rulerOrigin = RulerOrigin.PAGE_ORIGIN;    // }    makeMetaStyle(myDoc);//    var myParStyles = makeParstylesArray(myDoc);//    var myCharStyles = makeCharstylesArray(myDoc);     myList = myDoc.pages.everyItem().name;    myErrorLog = myErrorLog + "Got these Pages: "+ myList.toString() + "\n";  // set the XMLImport preferences    prcs_xmlImportPref(myDoc);    var simpleDialog =  app.dialogs.add({name:"Import Modes", canCancel:true});    var modeDropdown = 0;    // with(simpleDialog){      //Add a dialog column.      var sdiag_column1 = simpleDialog.dialogColumns.add();      var sdiag_row1 = sdiag_column1.dialogRows.add();      // with(dialogColumns.add()){        // with(dialogRows.add()){          modeDropdown = sdiag_row1.dropdowns.add({            stringList: ["Quick And Dirty","Advanced","Xml Import Only","Place all Prices"], selectedIndex:0,minWidth:75            });          // } // end of first row        // with(dialogRows.add()){          var xmlExistChkBx = sdiag_column1.checkboxControls.add({checkedState:false, staticLabel:"xml structure exists"});          // } // end of second row        // with(dialogRows.add()){          var xmlRmvChkBx = sdiag_column1.checkboxControls.add({checkedState:true, staticLabel:"remove xml @ end"});            // } // end of third row      // } // end of first column      //   with(dialogColumns.add()){      //   var gutter = staticTexts.add({staticLabel:"  ",minWidth:25});      // }    // } // end of -->with(simpleDialog)      //Display the fist dialog box.      if(simpleDialog.show() === true){        // true means quick and dirty        // false means advanced        obj.mode = modeDropdown.selectedIndex;        obj.xmlexist = xmlExistChkBx.checkedState;        obj.rmvxml = xmlRmvChkBx.checkedState;        simpleDialog.destroy();        // alert("DEBUG: "+obj.mode +" "+obj.xmlexist );        var myRoot;        if(!obj.xmlexist){        // alert("DEBUG: xml does not exist call the import");        try {          var myXMLFile = File.openDialog("Choose your .xml file");          myErrorLog = myErrorLog + "Got this xml file: "+ myXMLFile.displayName.toString() + "\n";          myRoot = myDoc.importXML(myXMLFile);        } catch (e) {          alert("ERROR: :( Sorry, your XML Document seems broken.\n" + e);            try{myXMLFile.execute(); }catch(_e){}          myErrorLog = myErrorLog + e.toString() + "\n";          exit();        }        try{          mapManually(myDoc);        }catch(e){          alert("ERROR: :( Sorry, you don't have the right styles in your document\nit will look wired\n" + e);          myErrorLog = myErrorLog + e.toString() + "\n";        }//        Count all items in.//        this isnt essential for the script        numOfItems = prcs_countItems(myDoc);        myErrorLog = myErrorLog + "Got "+ myList.toString() + "  items in this xml \n";        try{          prcs_makeAttributesFromInfo(myDoc);        }catch (e){        alert("ERROR: No i could not make your Attributes for processing the xml" + e);        myErrorLog = myErrorLog + e.toString() + "\n";        exit();        }        try{          prcs_sortGroups(myDoc);        }catch(e){          alert("ERROR: Could not move Elements to group" + e);          myErrorLog = myErrorLog + e.toString() + "\n";          exit();        }        try{    // first we move the normal ones to the front than the focus small stays at end        prcs_sortInGroupByPriority(myDoc);        }catch(e){          alert("ERROR: Could not move the normal Elements in group" + e);          myErrorLog = myErrorLog + e.toString() + "\n";          exit();        }          try{            prcs_makeImgElement(myDoc);          }catch (e){            alert("ERROR: Could not move the image Elements into new Element group" + e);            myErrorLog = myErrorLog + e.toString() + "\n";            exit();          }          try{            prcs_makeItemList(myDoc);          }catch (e){            alert("ERROR: Could not make the list of items. the single import wont work" + e);            myErrorLog = myErrorLog + e.toString() + "\n";            exit();          }    // -------------------------    // From here on it does something on the page    }// end of xmlimport into the doc    //if it already exist the whole  thing got skipped      } else {        // if the user pressed cancel        // stop the whole thing        simpleDialog.destroy();        return;      }  var myItemsListElement =  myDoc.xmlElements.item(0).xmlElements.item("itemsList");  for (var i =0 ;i < myItemsListElement.xmlElements.length;i++){    myItemsList[i] = myItemsListElement.xmlElements.item(i).markupTag.name;  }  myUI(myDoc, myPage,myPageName , myList,myItemsList,myErrorLog,myLogFile,obj.mode);    }/** * This builds the advanced dialog * @param  {[type]} myDoc       [description] * @param  {[type]} myPage      [description] * @param  {[type]} myPageName  [description] * @param  {[type]} myList      [description] * @param  {[type]} myItemsList [description] * @param  {[type]} myErrorLog  [description] * @param  {[type]} myLogFile   [description] * @param  {[type]} mode        [description] * @return {[type]}             [description] */function myUI(doc, myPage,myPageName, myList,myItemsList, myErrorLog, myLogFile, mode){  var myNumOItems = 0;  var minW = 400;  var advancedDialog = app.dialogs.add({name:"XMLImporter", canCancel:true,minWidth:minW});  var adiag_column1 = advancedDialog.dialogColumns.add();        var allSelector = adiag_column1.enablingGroups.add({          staticLabel: "place all and remove",          checkedState: true,          minWidth: minW        });          var myPlaceAll = allSelector.checkboxControls.add({            staticLabel: "place every item!",          checkedState: true          });          var myClearStructureCheckbox = allSelector.checkboxControls.add({            staticLabel: "remove all xml elements after import?",            checkedState: true          });        var pageSelector = adiag_column1.enablingGroups.add({          staticLabel: "choose page",          checkedState: false,          minWidth: minW        });        var pgsel_column1 = pageSelector.dialogColumns.add();        var pgsel_column2 = pageSelector.dialogColumns.add();            pgsel_column1.staticTexts.add({              staticLabel: "chose page to place"            });            var myPageDropdown = pgsel_column2.dropdowns.add({              stringList: myList,              selectedIndex: 0            });    // var groupSelector = enablingGroups.add({staticLabel: "place group", checkedState: false,minWidth :minW});    // with (groupSelector) {    //   with (dialogColumns.add()) {    //     staticTexts.add({    //       staticLabel: "chose group to place"    //     });    //   }    //   with (dialogColumns.add()) {    //     //Create a pop-up menu ("dropdown") control.    //     var myGroupDropdown = dropdowns.add({    //       stringList: ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"],    //       selectedIndex: 0    //     });    //   }    //   staticTexts.add({    //     staticLabel: "choose scope:"    //   });    //   var myRadioButtonGroup = radiobuttonGroups.add();    //   with (myRadioButtonGroup) {    //     var myLeftRadioButton = radiobuttonControls.add({    //       staticLabel: "focus",    //       checkedState: true    //     });    //     var myCenterRadioButton = radiobuttonControls.add({    //       staticLabel: "normal"    //     });    //     var myRightRadioButton = radiobuttonControls.add({    //       staticLabel: "small"    //     });    //   }    // }        var itemSelector = adiag_column1.enablingGroups.add({staticLabel: "place single item", checkedState: false,minWidth :minW});        var itemsel_column1 = itemSelector.dialogColumns.add();          var myArtikelDropdown = itemsel_column1.dropdowns.add({            stringList: myItemsList            //selectedIndex:0            });      var tbAndPrSelector = adiag_column1.enablingGroups.add({staticLabel: "tables or prices", checkedState: false,minWidth :minW});      var tbAndPrSel_column1 = tbAndPrSelector.dialogColumns.add();      var tbAndPrSel_row1 = tbAndPrSel_column1.dialogRows.add();      var tbAndPrSel_row2 = tbAndPrSel_column1.dialogRows.add();      var tbAndPrSel_row3 = tbAndPrSel_column1.dialogRows.add();        var myPlaceTablesCheckbox = tbAndPrSel_row1.checkboxControls.add({          staticLabel: "place all tables on selected page?"//        checkedState: true        });        var myPlacePricesCheckbox = tbAndPrSel_row2.checkboxControls.add({          staticLabel: "add all Prices from xml structure?"//        checkedState: true        });        // }        var myPlaceTablesExitCheckbox = tbAndPrSel_row3.checkboxControls.add({            staticLabel: "end after placing the tables or prices?",          checkedState: true          });    var placeAllBool;    var focusBool;    var normalBool;    var smallBool;    var itemBool;    var groupSelector;    var theItem;      var placeTables = false;      var exitAfterTables = true;      var placePrices = false;  //Display the dialog box.  if(obj.mode === 1){    if(advancedDialog.show() === true){//    var myPage;//    var myPageName;//    page selector box    if(pageSelector.checkedState !== true ){      myPage = doc.pages.add();      myPageName = myPage.name;    }else {//      myPage = myList[myPageDropdown.selectedIndex];      myPageName =  myList[myPageDropdown.selectedIndex];    }    if(tbAndPrSelector.checkedState === true && myPlacePricesCheckbox.checkedState === true){//      myPage = doc.pages.add();//      myPageName = myPage.name;    }    if(tbAndPrSelector.checkedState === true){      if(myPlaceTablesCheckbox.checkedState === true){        placeTables = true;        placePrices = false;      }else{        placeTables = false;      }      if(myPlacePricesCheckbox.checkedState === true){        placePrices = true;        placeTables = false;      }else{        placePrices = false;      }      if(myPlaceTablesExitCheckbox.checkedState === true){        exitAfterTables = true;      }else{        exitAfterTables = false;      }    }    if(placeTables === true ){      var myNewPage = doc.pages.item(myPageName);      for(var i = 0; i <11;i++){      prcs_placeAllTables(doc,myNewPage,i);        }      if(exitAfterTables === true){        exit();      }    }    if(placePrices === true ){      prcs_placeAllPrices(doc);      if(exitAfterTables === true){        exit();      }    }    if(allSelector.checkedState !== true){      placeAllBool = false;      clearStructure  = false;    }    if((myPlaceAll.checkedState === true) && (allSelector.checkedState === true)){      placeAllBool = true;      focusBool = false;      normalBool = false;      smallBool = false;      itemBool = false;//        groupSelector = 0;    } else{    // if(groupSelector.checkedState === true){    //   groupSelector = myGroupDropdown.selectedIndex;    //   placeAllBool = false;    //   if(myRadioButtonGroup.selectedButton === 0){    //     focusBool = true;    //     normalBool = false;    //     smallBool = false;    //     itemBool = false;    //   }else if(myRadioButtonGroup.selectedButton === 1){    //     focusBool = false;    //     normalBool = true;    //     smallBool = false;    //     itemBool = false;    //   }else if(myRadioButtonGroup.selectedButton === 2){    //     focusBool = false;    //     normalBool = false;    //     smallBool = true;    //     itemBool = false;    //   }    // }    if(itemSelector.checkedState === true){      placeAllBool = false;      focusBool = false;      normalBool = false;      smallBool = false;      itemBool = true;      var preTheItem = myItemsList[myArtikelDropdown.selectedIndex];      theItem = preTheItem.substring(4);    }    }    var clearStructure;    if((myClearStructureCheckbox.checkedState === true) && (allSelector.checkedState === true)){      clearStructure = true;    }else{      clearStructure = false;    }    advancedDialog.destroy();    myPage = doc.pages.item(myPageName);    // call function placeData    // in processXML.jsx    prcsXMLv02_placeData(doc, myPage, groupSelector, placeAllBool, focusBool, normalBool, smallBool,itemBool,theItem,myErrorLog,myLogFile);    if(clearStructure ===true ){      doc.xmlElements.everyItem().remove();    }  }else{      advancedDialog.destroy();      var myFile = myLogFile;      var myData = myErrorLog;      prcs_writeData (myFile, myData );      alert("all that thinking for nothing? Better luck nexttime!");  }    // end of dialog show  } else if (obj.mode === 0){    myPage = doc.pages.add();    myPageName = myPage.name;    placeAllBool = true;    focusBool = false;    normalBool = false;    smallBool = false;    itemBool = false;    theItem = null;    // call function placeData    // in processXML.jsx    prcsXMLv02_placeData(doc, myPage, groupSelector, placeAllBool, focusBool, normalBool, smallBool,itemBool,theItem,myErrorLog,myLogFile);    if(obj.rmvxml){    doc.xmlElements.everyItem().remove();  }    // end of --> else if (obj.mode === 0)    } else if (obj.mode === 2){      alert("Your import is done");    }else if (obj.mode === 3){      prcs_placeAllPrices(doc);      if(obj.rmvxml){      doc.xmlElements.everyItem().remove();      }      exit();    // };  }}// end of myUI method//---------- functions taken from RecordFindChange_CS3-CS5.jsx